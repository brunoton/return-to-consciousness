---
layout: default
---

{% if page.subtitle %}
<div class="essay-header">
  <h1 class="essay-title">{{ page.title }}</h1>
  <p class="essay-subtitle">{{ page.subtitle }}</p>
</div>
{% endif %}

<div class="floating-toc" id="floating-toc">
  <div class="toc-header">
    <span class="toc-title">Contents</span>
    <span class="toc-toggle">â–¼</span>
  </div>
  <div class="toc-content">
    <ul class="toc-nav" id="toc-nav">
      <!-- TOC will be auto-generated by JavaScript -->
    </ul>
  </div>
</div>

{{ content }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Make tables responsive by adding data-label attributes
    const tables = document.querySelectorAll('.page-content table');
    tables.forEach(table => {
        const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());

        table.querySelectorAll('tbody tr').forEach(row => {
            Array.from(row.querySelectorAll('td')).forEach((cell, index) => {
                if (headers[index]) {
                    cell.setAttribute('data-label', headers[index]);
                }
            });
        });
    });

    const toc = document.getElementById('floating-toc');
    const tocNav = document.getElementById('toc-nav');
    const tocHeader = document.querySelector('.toc-header');

    if (!toc || !tocNav) return;

    // Auto-generate TOC from headings
    const content = document.querySelector('.page-content');
    const headings = content.querySelectorAll('h2, h3, h4');
    const sections = [];

    headings.forEach((heading, index) => {
        // Get or create ID for the heading
        let id = heading.id;
        if (!id) {
            id = heading.textContent
                .toLowerCase()
                .replace(/[^\w\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/^-+|-+$/g, '');
            heading.id = id;
        }

        // Determine TOC level based on heading tag
        const level = heading.tagName === 'H2' ? 1 : heading.tagName === 'H3' ? 2 : 3;

        // Create TOC entry
        const li = document.createElement('li');
        const link = document.createElement('a');
        link.href = '#' + id;
        link.textContent = heading.textContent;
        link.className = 'toc-level-' + level;
        li.appendChild(link);
        tocNav.appendChild(li);

        // Store section info
        sections.push({
            id: id,
            element: heading,
            link: link,
            offset: 0
        });
    });

    // If no headings found, hide TOC
    if (sections.length === 0) {
        toc.style.display = 'none';
        return;
    }

    // Toggle TOC collapse/expand
    tocHeader.addEventListener('click', function() {
        toc.classList.toggle('collapsed');
        localStorage.setItem('tocCollapsed', toc.classList.contains('collapsed'));
    });

    // Restore TOC state
    const savedState = localStorage.getItem('tocCollapsed');
    if (savedState !== null) {
        if (savedState === 'true') {
            toc.classList.add('collapsed');
        }
    } else {
        if (window.innerWidth < 1660) {
            toc.classList.add('collapsed');
        }
    }

    // Smooth scrolling for TOC links
    const tocLinks = tocNav.querySelectorAll('a');
    tocLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            const targetElement = document.getElementById(targetId);

            if (targetElement) {
                const headerOffset = 80;
                const elementPosition = targetElement.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

                window.scrollTo({
                    top: offsetPosition,
                    behavior: 'smooth'
                });

                updateActiveLink(targetId);
            }
        });
    });

    // Update active link
    function updateActiveLink(forcedId = null) {
        if (forcedId) {
            tocLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === '#' + forcedId) {
                    link.classList.add('active');
                }
            });
            return;
        }

        const scrollPosition = window.pageYOffset + 100;
        let activeSection = null;

        for (let i = sections.length - 1; i >= 0; i--) {
            const section = sections[i];
            const sectionTop = section.element.getBoundingClientRect().top + window.pageYOffset;

            if (scrollPosition >= sectionTop) {
                activeSection = section;
                break;
            }
        }

        tocLinks.forEach(link => link.classList.remove('active'));
        if (activeSection) {
            activeSection.link.classList.add('active');
        }
    }

    // Intersection Observer for better section detection
    if ('IntersectionObserver' in window) {
        const observerOptions = {
            root: null,
            rootMargin: '-20% 0px -60% 0px',
            threshold: 0
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const activeId = entry.target.id;
                    tocLinks.forEach(link => {
                        link.classList.remove('active');
                        if (link.getAttribute('href') === '#' + activeId) {
                            link.classList.add('active');
                        }
                    });
                }
            });
        }, observerOptions);

        sections.forEach(section => {
            if (section.element) {
                observer.observe(section.element);
            }
        });
    } else {
        // Fallback to scroll-based detection
        let scrollTimeout;
        window.addEventListener('scroll', function() {
            if (scrollTimeout) clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(updateActiveLink, 16);
        }, { passive: true });
    }

    // Initial active link update
    updateActiveLink();

    // Mobile: hide TOC when scrolling down
    if (window.innerWidth <= 480) {
        let lastScrollTop = 0;
        window.addEventListener('scroll', function() {
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

            if (toc.classList.contains('collapsed') && Math.abs(scrollTop - lastScrollTop) > 100) {
                if (scrollTop > lastScrollTop && scrollTop > 200) {
                    toc.style.transform = 'translateY(150%)';
                } else {
                    toc.style.transform = 'translateY(0)';
                }
                lastScrollTop = scrollTop;
            } else if (!toc.classList.contains('collapsed')) {
                toc.style.transform = 'translateY(0)';
            }
        }, { passive: true });
    }
});
</script>
